<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TreWell</title>
<style>
  :root {
    --bg: #f4f4f4;
    --card: #ffffff;
    --accent: #697E50;
    --accent-dark: #354c2b;
    --text: #2f352f;
    --muted: #6e756f;
  }

  body {
    font-family: Inter, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 0;
    transition: all .2s;
  }

  .container {
    max-width: 980px;
    margin: 20px auto;
    padding: 20px;
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
  }

  .header { display: flex; justify-content: space-between; align-items: center; }
  .title { font-size: 30px; font-weight: 600; letter-spacing: 0.2px; }

  .btn {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 10px 14px;
    border-radius: 10px;
    cursor: pointer;
  }
  .btn.ghost {
    background: transparent;
    color: var(--accent-dark);
    border: 1px solid var(--accent-dark);
  }

  .card {
    background: linear-gradient(135deg, var(--accent-dark), var(--accent));
    color: #fff;
    padding: 22px;
    border-radius: 12px;
    margin-top: 16px;
    position: relative;
  }

  .balance { font-size: 30px; font-weight: 600; }

  .card-buttons {
    position: absolute;
    right: 18px;
    bottom: 14px;
    display: flex;
    gap: 8px;
  }

  .card-buttons button {
    background: rgba(255, 255, 255, 0.18);
    color: #fff;
    border: none;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
  }

  .section-head { display: flex; justify-content: space-between; align-items: center; margin-top: 18px; }

  .grid-section { margin-bottom: 30px; }
  .grid-title { font-size: 1.1rem; font-weight: 700; color: #516b12; margin: 10px 0; }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 14px;
  }

  .cat {
    background: var(--card);
    border-radius: 10px;
    padding: 12px;
    position: relative;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
  }

  .cat h4 { margin: 0; }
  .cat p { margin: 6px 0; font-size: 0.95rem; }

  .muted { color: var(--muted); }

  .menu-dot { position: absolute; top: 8px; right: 8px; cursor: pointer; font-weight: 700; }

  .menu-box {
    display: none;
    position: absolute;
    top: 32px;
    right: 8px;
    background: var(--card);
    color: var(--text);
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    min-width: 170px;
    overflow: hidden;
    z-index: 9999;
    pointer-events: auto;
  }

  .menu-box button {
    display: block;
    width: 100%;
    padding: 10px;
    border: none;
    background: transparent;
    text-align: left;
    cursor: pointer;
  }

  .menu-box button:hover { background: rgba(0, 0, 0, 0.03); }

  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    align-items: center;
    justify-content: center;
    z-index: 80;
  }

  .panel {
    background: var(--card);
    color: var(--text);
    padding: 16px;
    border-radius: 10px;
    width: 360px;
    max-width: 92%;
  }

  .field { margin: 8px 0; }

 .inputBox,
#loginUsername,
#loginPassword,
#signupUsername,
#signupEmail,
#signupPassword,
#signupConfirm,
#inpName,
#inpDesc,
#inpTarget,
#inpDate,
#inpBalanceAmount,
#inpDeductAmount,
#inpDepositAmount,
#inpWithdrawAmount {
  width: 100%;
  padding: 12px 14px;
  margin: 8px 0;
  border: 1px solid #dcdcdc;
  border-radius: 10px;
  background: #fafafa;
  font-size: 15px;
  outline: none;
  box-sizing: border-box;
  transition: 0.2s ease;
}

.inputBox:focus,
#loginUsername:focus,
#loginPassword:focus,
#signupUsername:focus,
#signupEmail:focus,
#signupPassword:focus,
#signupConfirm:focus,
#inpName:focus,
#inpDesc:focus,
#inpTarget:focus,
#inpDate:focus,
#inpBalanceAmount:focus,
#inpDeductAmount:focus,
#inpDepositAmount:focus,
#inpWithdrawAmount:focus {
  border-color: #4a5;
  background: #fff;
}
  .footer-note { text-align: center; margin-top: 12px; color: var(--muted); }

  @media (max-width: 600px) {
    .grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
    .card-buttons { position: static; margin-top: 12px; }
  }

  .sidebar {
  width: 260px;
  height: 100vh;
  background: #354c2b;
  position: fixed;
  top: 0;
  left: -260px;
  padding: 15px;
  color: #fff;
  transition: 0.25s ease;
  z-index: 999;
}

.sidebar h3 {
 
  margin-top: 0;
  margin-bottom: 16px;
  font-weight: 600;
      text-align: center;
  
}

.sidebar button {
  width: 100%;
  padding: 12px;
  margin-bottom: 8px;
  text-align: left;
  background: rgba(255,255,255,0.15);
  border: none;
  border-radius: 8px;
  color: #fff;
  cursor: pointer;
  font-size: 0.95rem;
  transition: 0.2s ease;
}

.sidebar button:hover {
  background: rgba(255,255,255,0.25);
}

.hamburger {
  position: fixed;
  left: 15px;
  top: 5px;
  background: #354c2b;
  color: #fff;
  border: none;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  z-index: 1000;
  font-size: 20px;
}
.confirmPopup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.confirmBox {
  background: var(--card);
  color: var(--text);
  padding: 18px;
  border-radius: 10px;
  width: 330px;
  max-width: 90%;
  text-align: center;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.confirmBtns {
  margin-top: 12px;
  display: flex;
  gap: 8px;
  justify-content: center;
}

</style>
</head>
<body>


<div id="loginScreen" style="display:flex; justify-content:center; align-items:center; height:100vh; background:#f4f4f4;">
  <div class="login-container" style="background:white; padding:30px; border-radius:8px; width:300px; box-shadow:0 0 10px rgba(0,0,0,0.1)">
    <h2>Login</h2>
    <input type="text" id="loginUsername" placeholder="Username" class="inputBox">
    <input type="password" id="loginPassword" placeholder="Password" class="inputBox">
    <span id="loginError" style="color:red; font-size:0.9em;"></span>
    <button onclick="login()" style="width:100%; padding:12px; background:#354c2b; color:white; border:none; border-radius:4px;">Login</button>
    <p style="text-align:center; margin-top:12px;">
      Don't have an account? <a href="#" onclick="showSignUp()">Sign Up</a>
    </p>
  </div>

  <div class="login-container" id="signUpBox" style="display:none; background:white; padding:30px; border-radius:8px; width:300px; box-shadow:0 0 10px rgba(0,0,0,0.1)">
    <h2>Sign Up</h2>
    <input type="text" id="signupUsername" placeholder="Username" class="inputBox">
    <input type="email" id="signupEmail" placeholder="Email" class="inputBox">
    <input type="password" id="signupPassword" placeholder="Password" class="inputBox">
    <input type="password" id="signupConfirm" placeholder="Confirm Password" class="inputBox">
    <span id="signupError" style="color:red; font-size:0.9em;"></span>
    <button onclick="signUp()" style="width:100%; padding:12px; background:#354c2b; color:white; border:none; border-radius:4px;">Sign Up</button>
    <p style="text-align:center; margin-top:12px;">
      Already have an account? <a href="#" onclick="showLogin()">Login</a>
    </p>
  </div>
</div>

<div id="mainApp" style="display:none;">
  <div class="container">
    <div class="header">
      <div class="title">TreWell</div>
      
    </div>

  
<div class="sidebar" id="sidebar">
    <h3>Menu</h3>

    <button onclick="openDeletedOverlay()">üóëÔ∏è Deleted</button>

    <hr style="border:none;height:1px;background:rgba(255,255,255,0.12);margin:12px 0">

    <button onclick="logout()" style="background:#e74c3c;">üö™ Logout</button>
</div>


<button class="hamburger" id="hambtn" onclick="toggleSidebar()">‚ò∞</button>

    
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div style="font-size:0.95rem;opacity:0.95">Wallet Balance</div>
          <div class="balance"><span id="balance">0.00</span> <span id="cur">USD</span></div>
        </div>

        <div class="card-buttons">
          <button title="Reset" onclick="openResetPopup()">‚Üª</button>
          <button title="Add balance" onclick="showAddBalancePopup()">Ôºã</button>
          <button title="Subtract balance" onclick="openDeductPopup()">Ôºç</button>
          
        </div>
      </div>
    </div>

    <div class="section-head">
      <h3 id="sectionTitle">Short-term Categories</h3>
      <button class="btn" onclick="showPopup()">Ôºã Add Category</button>
    </div>

    
    <div class="grid" id="grid"></div>
  </div>
</div>




<div class="overlay" id="overlayBalance">
  <div class="panel">
    <h3 id="panelBalanceTitle">Add to Main Balance</h3>
    <div class="field">
      <input id="inpBalanceAmount" type="text" placeholder="Enter amount">
    </div>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="btn" onclick="saveBalance()">Save</button>
      <button class="btn ghost" onclick="closeBalancePopup()">Cancel</button>
    </div>
  </div>
</div>


<div class="overlay" id="overlayDeduct">
  <div class="panel">
    <h3 id="panelDeductTitle">Deduct from Main Balance</h3>
    <div class="field">
      <input id="inpDeductAmount" type="text" placeholder="Enter amount">
    </div>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="btn" onclick="deductBalance()">OK</button>
      <button class="btn ghost" onclick="closeDeductPopup()">Cancel</button>
    </div>
  </div>
</div>


<div class="overlay" id="overlay">
  <div class="panel">
    <h3 id="panelTitle">Add Category</h3>
    <div class="field"><input id="inpName" class="inputBox" type="text" placeholder="Category name"></div>
<div class="field"><input id="inpDesc" class="inputBox" type="text" placeholder="Description"></div>
<div class="field"><input id="inpTarget" class="inputBox" type="text" placeholder="Target amount"></div>
<div class="field"><input id="inpDate" class="inputBox" type="text" placeholder="Select Date"></div>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="btn" onclick="saveCategory()">Save</button>
      <button class="btn ghost" onclick="closePopup()">Cancel</button>
    </div>
  </div>
</div>


<div class="overlay" id="overlayDeposit">
  <div class="panel">
    <h3 id="panelDepositTitle">Deposit to Category</h3>
    <div class="field">
      <input id="inpDepositAmount" type="text" placeholder="Enter amount">
    </div>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="btn" onclick="confirmDeposit()">Save</button>
      <button class="btn ghost" onclick="closeDepositPopup()">Cancel</button>
    </div>
  </div>
</div>


<div class="overlay" id="overlayWithdraw">
  <div class="panel">
    <h3 id="panelWithdrawTitle">Withdraw from Category</h3>
    <div class="field">
      <input id="inpWithdrawAmount" type="text" placeholder="Enter amount">
    </div>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="btn" onclick="confirmWithdraw()">Withdraw</button>
      <button class="btn ghost" onclick="closeWithdrawPopup()">Cancel</button>
    </div>
  </div>
</div>


<div class="overlay" id="overlayDelete">
  <div class="panel">
    <h3 id="panelDeleteTitle">Delete Category</h3>
    <p id="deleteMessage">Are you sure you want to delete this category?</p>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="btn" onclick="confirmDelete()">OK</button>
      <button class="btn ghost" onclick="closeDeletePopup()">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="delOverlay">
  <div class="panel">
    <h3>Deleted Categories</h3>
    <div id="deletedList"></div>
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="btn" onclick="closeDeleted()">Close</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlayReset">
  <div class="panel">
    <h3 id="panelResetTitle">Reset Main Balance</h3>
    <p>Are you sure you want to reset your main balance?</p>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="btn" onclick="confirmResetBalance()">Confirm</button>
      <button class="btn ghost" onclick="closeResetPopup()">Cancel</button>
    </div>
  </div>
</div>


<div class="overlay" id="overlayMessage">
  <div class="panel">
    <p id="msgText"></p>
    <button class="btn" onclick="closeMsg()">OK</button>
  </div>
</div>

<div id="motivationBox" style="
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(40px);
  background: #354c2b;
  color: #fff;
  padding: 12px 18px;
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  opacity: 0;
  transition: 0.35s ease;
  z-index: 99999;
  pointer-events:none;
"></div>

<div id="twAutoConfirm" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.45);
  align-items:center; justify-content:center;
  z-index:999999;">
  
  <div style="background:white; padding:18px; border-radius:10px;
    width:320px; max-width:90%; text-align:center;
    box-shadow:0 6px 20px rgba(0,0,0,0.2);">
    
    <p id="twACmsg" style="font-size:1.05rem; margin-bottom:18px;"></p>

    <div style="display:flex; gap:8px; justify-content:center;">
      <button class="btn" id="twACyes">OK</button>
      <button class="btn ghost" id="twACno">Cancel</button>
    </div>
  </div>

</div>






<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>

function showSignUp() {
  document.querySelector(".login-container").style.display = "none";
  document.getElementById("signUpBox").style.display = "block";
}

function showLogin() {
  document.querySelector(".login-container").style.display = "block";
  document.getElementById("signUpBox").style.display = "none";
}

function signUp() {
  const u = signupUsername.value.trim();
  const e = signupEmail.value.trim();
  const p = signupPassword.value.trim();
  const c = signupConfirm.value.trim();

  if (!u || !e  ||!p || !c) return signupError.innerText = "Fill all fields";
  if (!e.includes("@")) return signupError.innerText = "Email must contain @";

  const passRegex = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[\W_]).+$/;
  if (!passRegex.test(p)) return signupError.innerText = "Password must include letter, number & symbol";
  if (p !== c) return signupError.innerText = "Passwords don't match";

  if (localStorage.getItem("user_" + u)) return signupError.innerText = "User already exists";

  const newUser = { username: u, email: e, password: p };
  localStorage.setItem("user_" + u, JSON.stringify(newUser));
  localStorage.setItem("currentUser", u);
  localStorage.setItem("loggedIn", "true");
  location.reload();
}

function login() {
  const u = loginUsername.value.trim();
  const p = loginPassword.value.trim();

  const data = localStorage.getItem("user_" + u);
  if (!data) return loginError.innerText = "Invalid username";

  const user = JSON.parse(data);
  if (user.password !== p) return loginError.innerText = "Wrong password";

  localStorage.setItem("currentUser", u);
  localStorage.setItem("loggedIn", "true");
  location.reload();
}

function logout() {
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("currentUser");
  document.getElementById("mainApp").style.display = "none";
  document.getElementById("loginScreen").style.display = "flex";
}

window.onload = function() {
  if (localStorage.getItem("loggedIn") === "true") {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("mainApp").style.display = "block";
  }
};

function showMsg(text) {
    const box = document.getElementById("msgBox");
    box.innerText = text;

    box.style.opacity = "1";
    box.style.transform = "translateX(-50%) translateY(0)";

    setTimeout(() => {
        box.style.opacity = "0";
        box.style.transform = "translateX(-50%) translateY(40px)";
    }, 2100);
}
function showConfirmBox(msg, yesAction) {
    document.getElementById("confirmText").innerText = msg;
    document.getElementById("confirmOverlay").style.display = "flex";

    const btn = document.getElementById("confirmYesBtn");
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);

    newBtn.addEventListener("click", () => {
        yesAction();
        closeConfirmBox();
    });
}

function closeConfirmBox() {
    document.getElementById("confirmOverlay").style.display = "none";
}
const motivationArray = [
    "Great job! Keep going! üåü",
    "Your progress is amazing! üí™",
    "Small steps lead to big results. üëè",
    "You‚Äôre doing fantastic! Keep it up! üî•",
    "Proud of you! Stay focused! üíö",
    "You're getting closer to your goals! üöÄ",
    "Consistency is key. You got this! ‚≠êÔ∏è",
    "One step at a time. You're doing great! üí´"
];

function showMotivation() {
    const box = document.getElementById("motivationBox");
    const rand = Math.floor(Math.random() * motivationArray.length);

    box.innerText = motivationArray[rand];
    box.style.opacity = "1";
    box.style.transform = "translateX(-50%) translateY(0)";

    setTimeout(() => {
        box.style.opacity = "0";
        box.style.transform = "translateX(-50%) translateY(40px)";
    }, 2000); 
}
 

flatpickr("#inpDate", { dateFormat: "Y-m-d", locale: "en", allowInput: true });


let user = localStorage.getItem("currentUser") || "";
const KEY_BAL = 'tw_balance_${user}';
const KEY_CATS = 'tw_categories_${user}';
const KEY_DEL  = 'tw_deleted_${user}';

let balance   = parseFloat(localStorage.getItem(KEY_BAL)) || 0;
let categories = JSON.parse(localStorage.getItem(KEY_CATS) || '[]');
let deleted    = JSON.parse(localStorage.getItem(KEY_DEL) || '[]');
let currency   = "USD"; 

function saveAll(){
  localStorage.setItem(KEY_BAL, balance.toFixed(2));
  localStorage.setItem(KEY_CATS, JSON.stringify(categories));
  localStorage.setItem(KEY_DEL, JSON.stringify(deleted));
}


function formatNum(n){ return Number(n).toFixed(2); }

function showMsg(text) {
  const ov = document.getElementById('overlayMessage');
  document.getElementById('msgText').innerText = text;
  ov.style.display = 'flex';
}

function closeMsg(){ document.getElementById('overlayMessage').style.display = 'none'; }


function updateBalanceUI(){
  document.getElementById('balance').innerText = formatNum(balance);
  document.getElementById('cur').innerText = currency;
}

function showAddBalancePopup() {
  document.getElementById('inpBalanceAmount').value = '';
  document.getElementById('overlayBalance').style.display = 'flex';
}

function closeBalancePopup() { document.getElementById('overlayBalance').style.display = 'none'; }

function saveBalance() {
  const input = document.getElementById('inpBalanceAmount').value;
  const v = parseFloat(input.replace(',', '.'));
  if (isNaN(v) || v <= 0) return showMsg('Invalid amount');
  balance += v;
  saveAll();
  updateBalanceUI();
  showMsg('Added');
  closeBalancePopup();
}

(function(){

  let pendingAction = null;

  function openAutoConfirm(msg, callback){
    pendingAction = callback;

    document.getElementById("twACmsg").innerText = msg;
    document.getElementById("twAutoConfirm").style.display = "flex";
  }

  function closeAutoConfirm(){
    document.getElementById("twAutoConfirm").style.display = "none";
  }

  document.getElementById("twACyes").onclick = function(){
    closeAutoConfirm();
    if (pendingAction) pendingAction();
  };

  document.getElementById("twACno").onclick = function(){
    closeAutoConfirm();
  };



  const oldConfirmDeposit = window.confirmDeposit;
  window.confirmDeposit = function(){
    openAutoConfirm("Confirm deposit?", () => oldConfirmDeposit());
  };

  const oldConfirmWithdraw = window.confirmWithdraw;
  window.confirmWithdraw = function(){
    openAutoConfirm("Confirm withdraw?", () => oldConfirmWithdraw());
  };

  const oldSaveBalance = window.saveBalance;
  window.saveBalance = function(){
    openAutoConfirm("Add to main balance?", () => oldSaveBalance());
  };

  const oldDeductBalance = window.deductBalance;
  window.deductBalance = function(){
    openAutoConfirm("Withdraw from main wallet?", () => oldDeductBalance());
  };

  const oldConfirmDelete = window.confirmDelete;
  window.confirmDelete = function(){
    openAutoConfirm("Delete this category?", () => oldConfirmDelete());
  };

  const oldConfirmReset = window.confirmResetBalance;
  window.confirmResetBalance = function(){
    openAutoConfirm("Reset main balance?", () => oldConfirmReset());
  };

})();

function openDeductPopup() {
  document.getElementById('inpDeductAmount').value = '';
  document.getElementById('overlayDeduct').style.display = 'flex';
}
function closeDeductPopup() { document.getElementById('overlayDeduct').style.display = 'none'; }

function deductBalance() {
  const amount = parseFloat(document.getElementById('inpDeductAmount').value);
  if (isNaN(amount) || amount <= 0) return showMsg('Enter a valid amount');
  if (amount > balance) return showMsg('Not enough balance');
  balance -= amount;
  updateBalanceUI();
  saveAll();
  closeDeductPopup();
  showMsg('Amount withdrawn successfully!');
}


let currentView = 'home';
let editIndex = -1;

function showView(v){ currentView = v; renderAll(); document.getElementById('sectionTitle').innerText = 'Short-term Categories'; }

function showPopup(i=-1){
  editIndex = i;
  document.getElementById('overlay').style.display = 'flex';
  document.getElementById('panelTitle').innerText = (i===-1) ? 'Add Category' : 'Edit Category';

  if(i!==-1){
    const c = categories[i];
    inpName.value = c.name;
    inpDesc.value = c.desc;
    inpTarget.value = c.target;
    inpDate.value = c.date;
  } else {
    inpName.value = '';
    inpDesc.value = '';
    inpTarget.value = '';
    inpDate.value = '';
  }
}

function closePopup(){ document.getElementById('overlay').style.display = 'none'; }


function saveCategory(){
  const n = inpName.value.trim();
  const d = inpDesc.value.trim();
  const t = parseFloat(inpTarget.value);
  const date = inpDate.value;


  if (!n || !d || isNaN(t) || t <= 0 || !date) return showMsg('Fill all fields');
  if (t > 9999.9) return showMsg('Short-term goals must be 9999.9 or less');

  if (editIndex === -1) {
    categories.push({
      id: Date.now(),
      name: n,
      desc: d,
      target: +t,
      amount: 0,
      date,
      type: 'short'
    });
    showMsg('Added');
  } else {
    const c = categories[editIndex];
    c.name = n;
    c.desc = d;
    c.target = +t;
    c.date = date;
    showMsg('Updated');
  }

  editIndex = -1;
  saveAll();
  closePopup();
  renderAll();
}


let depositIndex = null;
function openDepositPopup(i) {
  depositIndex = i;
  document.getElementById('inpDepositAmount').value = '';
  document.getElementById('overlayDeposit').style.display = 'flex';
}
function closeDepositPopup() { document.getElementById('overlayDeposit').style.display = 'none'; }

function confirmDeposit() {
  const c = categories[depositIndex];
  const v = parseFloat(document.getElementById('inpDepositAmount').value);

  if (isNaN(v) || v <= 0) return showMsg('Enter a valid amount');
  if (c.amount >= c.target) return showMsg('This category has already reached its target!');
  const maxDeposit = c.target - c.amount;
  if (v > maxDeposit) return showMsg(`You can only deposit up to ${maxDeposit.toFixed(2)} to reach the goal.`);
  if (v > balance) return showMsg('Insufficient balance');

  c.amount += v;
  balance -= v;
  saveAll();
  updateBalanceUI();
  renderAll();
  showMsg('Deposited');
  closeDepositPopup();
  showMotivation()  
}
function openResetPopup() {
  document.getElementById('overlayReset').style.display = 'flex';
}

function closeResetPopup() {
  document.getElementById('overlayReset').style.display = 'none';
}


function confirmResetBalance() {
  balance = 0; 
  updateBalanceUI(); 
  closeResetPopup();
}
let withdrawIndex = null;
function openWithdrawPopup(i) {
  withdrawIndex = i;
  document.getElementById('inpWithdrawAmount').value = '';
  document.getElementById('overlayWithdraw').style.display = 'flex';
}
function closeWithdrawPopup() { document.getElementById('overlayWithdraw').style.display = 'none'; }

function confirmWithdraw() {
  const c = categories[withdrawIndex];
  const v = parseFloat(document.getElementById('inpWithdrawAmount').value);

  if (isNaN(v) || v <= 0) return showMsg('Enter a valid amount');
  if (v > c.amount) return showMsg('Exceeds category balance');

  c.amount -= v;
  balance += v;
  saveAll();
  updateBalanceUI();
  renderAll();
  showMsg(`Withdrawn ${v.toFixed(2)} from "${c.name}"`);
  closeWithdrawPopup();
}


let deleteIndex = null;

function openDeletePopup(i) {
  deleteIndex = i;
  document.getElementById('overlayDelete').style.display = 'flex';
  const c = categories[i];
  document.getElementById('deleteMessage').textContent = 'Are you sure you want to delete it?';
}

function closeDeletePopup() { document.getElementById('overlayDelete').style.display = 'none'; }

function confirmDelete() {
  const i = deleteIndex;
  const c = categories[i];
  balance += c.amount; 
  deleted.push({ ...c });
  categories.splice(i, 1);
  saveAll();
  renderAll();
  showMsg(`Deleted "${c.name}" and returned ${c.amount.toFixed(2)} to balance`);
  closeDeletePopup();
}

function toggleSidebar() {
  const s = document.getElementById("sidebar");
  s.style.left = (s.style.left === "0px") ? "-260px" : "0px";
}

function openDeletedOverlay(){
  const div = document.getElementById('deletedList');
  div.innerHTML = '';
  if (deleted.length === 0) {
    div.innerHTML = '<div style="opacity:0.7">No deleted categories</div>';
    document.getElementById('delOverlay').style.display = 'flex';
    return;
  }
  deleted.forEach((c,i) => {
    const d = document.createElement('div');
    d.style.borderBottom = '1px solid #ccc';
    d.style.padding = '6px 0';
    d.innerHTML = `
      <strong>${escapeHtml(c.name)}</strong> (${escapeHtml(c.date)})<div style="margin-top:4px;display:flex;gap:6px">
        <button class="btn" onclick="restoreCat(${i})">Restore</button>
      </div>
    `;
    div.appendChild(d);
  });
  document.getElementById('delOverlay').style.display = 'flex';
}

function closeDeleted(){ document.getElementById('delOverlay').style.display = 'none'; }

function restoreCat(i){
  const c = deleted[i];
  c.amount = 0;
  categories.push(c);
  deleted.splice(i, 1);
  saveAll();
  renderAll();
  openDeletedOverlay();
  showMsg(`Restored "${c.name}" (amount reset to 0)`);
}


function renderAll(){
  updateBalanceUI();
  const grid = document.getElementById('grid');
  grid.innerHTML = '';

  if (categories.length === 0) {
    grid.innerHTML = '<div style="opacity:0.6">No short-term categories</div>';
    return;
  }

  categories.forEach((c, idx) => {
    const over = c.amount > c.target;
    const div = document.createElement('div');
    div.className = 'cat';

    div.innerHTML = `
      <div class="menu-dot" onclick="toggleMenu(${idx})">‚ãÆ</div>
      <div class="menu-box" id="menubox${idx}">
        <button onclick="openDepositPopup(${idx})">üí∞ Deposit</button>
        <button onclick="openWithdrawPopup(${idx})">üí∏ Withdraw</button>
        <button onclick="editCat(${idx})">‚úèÔ∏è Edit</button>
        <button onclick="openDeletePopup(${idx})">üóëÔ∏è Delete</button>
      </div>
      <h4>${escapeHtml(c.name)}</h4>
      <p class="muted">${escapeHtml(c.desc)}</p>
      <p><strong>${formatNum(c.amount)} / ${formatNum(c.target)} ${currency} ${over ? '<span style="color:#c11;font-weight:700">(Over)</span>' : ''}</strong></p>
      <p class="muted">Date: ${escapeHtml(c.date)}</p>
    `;
    grid.appendChild(div);
  });
}

function editCat(i){ showPopup(i); }

function toggleMenu(i){
  document.querySelectorAll('[id^="menubox"]').forEach(m => m.style.display='none');
  const e = document.getElementById('menubox'+i);
  e.style.display = (e.style.display === 'block') ? 'none' : 'block';
}

function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }


document.addEventListener('click', e => {
  const isMenu = e.target.closest('.menu-dot') || e.target.closest('.menu-box');
  if (!isMenu) document.querySelectorAll('[id^="menubox"]').forEach(el => el.style.display='none');
});

 

   function removeDeleted(i){ const c = deleted[i];
  const confirmBox = document.createElement('div');
  confirmBox.className = 'confirm-overlay';
  confirmBox.innerHTML = `
    <div class="confirm-panel">
      <h3>Delete Permanently</h3>
      <p>Are you sure you want to permanently delete it?</p>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button class="btn" id="yesDelete">Yes</button>
        <button class="btn ghost" id="noDelete">Cancel</button>
      </div>
    </div>
  `;
  document.body.appendChild(confirmBox);
  
  document.getElementById('yesDelete').onclick = () => {
    deleted.splice(i, 1);
    saveAll();
    openDeletedOverlay();
    showMsg('Deleted permanently');
    document.body.removeChild(confirmBox);
  };
  
  document.getElementById('noDelete').onclick = () => {
    document.body.removeChild(confirmBox);
  };}

  function closeDeleted(){delOverlay.style.display='none';}

updateBalanceUI();
renderAll();
</script>
</body>
</html>
